# タスク管理アプリの同期問題と解決方針

## プロジェクト概要
- **目的**: Next.jsでタスク管理Webアプリを開発。Obsidianの保管庫をアプリ側でFileSystem Access APIを使用して、
  にタスクをマークダウン形式で保存し、Obsidianで確認。
- **ワークフロー**:
  - アプリでタスクを操作（追加/編集/削除）。
  - 手動同期ボタン（例: 「Obsidianに同期」）で保管庫に保存。
  - Obsidianに切り替えてタスク確認（非リアルタイム同期）。
- **開発ツール**: Next.js（クライアントサイド）、FileSystem Access API

## 現状の問題点
- **ページ構成**:
  - `/setting`: 同期先フォルダを選択。
  - `/`（トップページ）: タスク管理。
  - 問題: ページ遷移（`/setting` ↔ `/`）やリロードで、FileSystem Access APIのハンドル（`FileSystemFileHandle`）がリセットされ、操作許可が失効。
- **同期の課題**:
  - リロードやセッション終了後、フォルダ再選択が必要（完全自動同期が不可）。
  - ユーザーが頻繁に再選択するのは面倒、UX低下。
  - 再接続中のエラー（例: ハンドル未設定）を防ぎたい。
- **Windsurfの課題**:
  - 非同期処理（`useEffect`、API呼び出し）や状態管理でAIがバグを生成（例: 無限ループ、エラーハンドリング漏れ）。
  - コードレビューとデバッグが必要。

## FileSystem Access APIの仕様と問題
- **仕様**:
  - ユーザーがフォルダ/ファイルを選択すると、ハンドル（`FileSystemFileHandle`/`FileSystemDirectoryHandle`）が生成。
  - ハンドルでローカルファイルに読み書き可能（例: `Tasks.md`にマークダウン保存）。
  - セキュリティ制約:
    - ユーザー許可（選択、許可確認）必須。
    - ハンドルはセッション依存、リロードやブラウザ終了で無効。
    - ハンドルを`localStorage`や`indexedDB`に直接保存不可（オブジェクト、シリアライズ不可）。
  - 互換性: Chrome/Edgeのみ（Safari/Firefox未対応）。
- **問題**:
  - リロードやページ遷移でハンドルが無効、毎回再選択が必要。
  - 完全自動同期は仕様上不可能（ユーザー許可必須）。
  - 再選択の頻度が高くとUX低下。
  - 再接続中のエラー（例: ハンドル未設定）が発生しやすい。

## 解決方法
### 1. 1ページへの統合（`/setting`の廃止）
- **提案**:
  - `/setting`ページをなくし、同期設定（フォルダ選択）とタスク管理をトップページ（`/`）に統合。
  - 同期設定はモーダルウィンドウで実現（例: 「同期設定」ボタンでモーダル表示、フォルダ選択）。
  - 手動同期ボタン（「Obsidianに同期」）で、Obsidianの保管庫に保存。
- **効果**:
  - **ページ遷移の削減**:
    - 遷移（`/setting` ↔ `/`）によるハンドルリセットがなくなる。
    - ハンドルを`useState`でトップページに保持、クライアントサイド状態を維持。
  - **UX向上**:
    - タスク管理と同期設定を1画面で完結。
    - モーダルで設定UIをシンプルに、トップページはタスク管理に集中。
  - **コード管理**:
    - ハンドルや設定を1コンポーネントで管理、状態共有が簡単（`useState`やContext）。
    - Windsurfで生成しやすい（単一ページのコンポーネント構造）。
- **限界**:
  - リロード時のハンドルリセットはAPI仕様上不可避。
  - 解決策: `localStorage`にフォルダ名を保存、モーダルで再選択を促す（1クリックで復元）。

### 2. モーダルウィンドウでの同期設定
- **実装**:
  - トップページに「同期設定」ボタン、クリックでモーダル表示。
  - モーダル内で`showSaveFilePicker`/`showDirectoryPicker`でフォルダ選択。
  - 前回パスを`localStorage`から提案
- **効果**:
  - ページ遷移なしで設定変更、ハンドルリセットを回避。
  - トップページのUIをシンプルに（タスク管理に集中）。
  - 再選択をモーダルでスムーズに（UX向上）。
  - WindsurfでモーダルUI生成が簡単（Tailwind CSS推奨）。
- **リロード対応**:
  - `useEffect`で`localStorage`からパスを読み込み、モーダル自動表示（再選択促す）。
  - 再接続中はポップアップ（「同期中...」）でエラー回避。

### 3. 手動同期ボタン
- **実装**:
  - トップページに「Obsidianに同期」ボタン。
  - 押下時:
    - ハンドルがあれば即保存（マークダウンで例：`Tasks.md`に）。
    - ハンドルなしならモーダルで選択。
  - 保存中/完了時にポップアップ（「同期中」「同期完了！」）。
  - マークダウンはObsidianのTasksプラグイン（`- [ ] タスク名`）やDataview（フロントマター）互換。
- **効果**:
  - ユーザーの意図（「Obsidianで確認するタイミング」）に合わせた同期。
  - ツール切り替え（アプリ→Obsidian）前に確実保存、Obsidianで即確認。
  - APIの制約（ユーザー許可必須）を手動操作でクリア。
  - ポップアップでエラー回避とフィードバック、UX向上。
- **ワークフロー**:
  - タスク操作→「同期」ボタン→保存→Obsidian切り替え→`Tasks.md`確認。
  - 非リアルタイムで競合なし、シンプル。

### 4. エラー回避とUX最適化
- **ポップアップ**:
  - 同期中（`isSyncing`）に「同期中...」表示、ボタン無効化（エラー防止）。
  - 同期完了で「同期完了！Obsidianで確認してください」。
  - エラー時（例: 権限失効）はモーダル再表示（「フォルダを再選択」）。
- **再選択の簡略化**:
  - `localStorage`で前回パスを保存、モーダルで提案（例: 「Tasks.mdを再選択」）。
  - セッション内キャッシュ（`indexedDB`）を検討（リロード時の再選択減）。
- **フォールバック**:
  - API未対応ブラウザ（Safari/Firefox）向けに、手動ダウンロード（Blobで`Tasks.md`出力）。
  - UIで「Chrome推奨」案内。

### 5. ページをリロードしていない状態
APIが問題なく機能している状態のときは、タスクの更新や新規登録、削除があった場合で同期を自動で行いたい