# Obsidian Task Sync - 更新仕様書

## 概要

Obsidian Task Syncは、Obsidian保管庫とWebアプリケーション間でタスク管理を同期するツールです。この仕様書では、ユーザーからのフィードバックに基づいて更新された仕様を説明します。

## データ管理の基本原則

データは「ローカルDB」のようにマークダウンファイルで管理します。以下の3つのファイルを使用します：

1. **tasks.md** - タスクデータ管理用
2. **tags.md** - タグデータ管理用
3. **tasks-tags.md** - タスクとタグの関連付け管理用

これらのファイルは、どのユーザーでも共通で固定のファイル名として使用されます。

## 更新された仕様

### 1. タスク管理の基本構造

#### 旧仕様
- 各タスクが個別のマークダウンファイルとして保存される
- タスク名がランダムなIDベースのファイル名になる（例：`task-mas7hnow-27r6j.md`）
- タスクのステータス変更が同期時に初期化される問題がある

#### 新仕様
- **すべてのタスクは1つのマークダウンファイル（`tasks.md`）に集約**
- タスク管理用のファイルは固定パス（`Tasks/tasks.md`）に保存
- ファイル内部はカンマ区切りのCSV形式で管理
  - 各行は `id, タスク名, ステータス, 納期, 紐づいているリンクノート` の形式
  - ステータスは数値で管理（1: 未着手, 2: 進行中, 3: 完了）
- すべてのObsidianユーザーで同じファイル構造を使用
- タスクはこのファイルに追加・更新され、ローカルDBのような役割を果たす
- タスクのステータス変更は同期後も保持される

### 2. デイリーノート連携

#### 旧仕様
- アプリが新しくデイリーノート用のフォルダを作成
- そこに新規デイリーノートを作成して同期

#### 新仕様
- **ユーザーが既存のデイリーノートフォルダを選択**
- デイリーノートの命名規則（YYYY-MM-DD形式など）を設定画面で指定可能
- 最新のデイリーノートを検出して、そこにタスク情報を追記
- 最新のデイリーノートが存在しない場合は新規作成
- **未着手タスクと進行中タスクのみ**をデイリーノートに表示
- 既存のデイリーノート形式を尊重

### 3. リンク先ノート管理

#### 旧仕様
- タスクにリンクされたノートの管理方法が不明確
- リンク表記に問題がある（`[[[[ノート]]`のような二重括弧の問題）

#### 新仕様
- タスクからリンクされたノートは、ユーザーが指定したフォルダに保存
- ノートリンクの入力タイトルでノートが作成される
- ノートテンプレート機能を使用して、新規ノート作成時の内容を定義
- リンク表記の問題を修正（適切な`[[ノート]]`形式を使用）

### 4. タグ管理

#### 旧仕様
- タグはタスクの属性として保存
- Obsidianのタグシステムとの連携が不十分

#### 新仕様
- **タグ用の専用ノート（`tags.md`）を作成**
  - ファイル内部は `id, タグ名` の形式で管理
- **タスクとタグの関連付け用のファイル（`tasks-tags.md`）を作成**
  - ファイル内部は `id, tag_id, task_id` の形式で管理
  - `tag_id` は `tags.md` の `id` と紐付く
  - `task_id` は `tasks.md` の `id` と紐付く
- Webアプリでタグ入力時に、既存タグをサジェスト表示
- Obsidianのタグシステムとは独立した管理

### 5. ノートテンプレート

#### 旧仕様
- テンプレートの適用対象が不明確

#### 新仕様
- **テンプレートはタスクのノートリンクから作成される新規ノートに適用**
- タスクにリンクされたノートは、ユーザーが指定したフォルダに保存
- テンプレート内の変数（`{{title}}`, `{{date}}`, `{{taskId}}`など）を適切に置換
- ユーザーがテンプレート内容をカスタマイズ可能

## 同期の仕組み

1. **タスク同期**
   - Webアプリのタスク変更は`Tasks/tasks.md`に集約
   - タスクはカンマ区切りのCSV形式で管理
   - ステータスは数値（1: 未着手, 2: 進行中, 3: 完了）で管理
   - タスクのステータス変更は同期後も保持
   - 同期はユーザーの手動操作または設定された間隔で実行

2. **デイリーノート同期**
   - 最新のデイリーノートを検出
   - デイリーノートが存在しない場合は新規作成
   - **未着手・進行中タスクのみ**をデイリーノートに追記
   - デイリーノートの既存構造を維持

3. **ノート同期**
   - タスクからリンクされた新規ノートは指定フォルダに作成
   - テンプレートを適用して初期内容を設定
   - 双方向リンクでタスクとノートを関連付け

4. **タグ同期**
   - タグ情報は`tags.md`に集約（`id, タグ名`形式）
   - タスクとタグの関連付けは`tasks-tags.md`に管理（`id, tag_id, task_id`形式）
   - Webアプリでのタグ入力時にサジェスト機能を提供

## 設定項目

1. **保管庫フォルダ**
   - Obsidian保管庫のルートディレクトリを選択

2. **デイリーノートフォルダ**
   - ユーザーの既存デイリーノートが保存されているフォルダを選択
   - デイリーノートの命名規則を設定（YYYY-MM-DD形式など）

3. **ノート保存先フォルダ**
   - タスクからリンクされる新規ノートの保存先を選択

4. **同期設定**
   - 同期間隔、起動時同期、フォーカス時同期などの設定

5. **ノートテンプレート**
   - 新規ノート作成時に適用されるテンプレートを定義
   - 変数を使用してタスク情報を埋め込み可能
